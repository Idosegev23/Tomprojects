# 📝 אפיון מערכת ניהול פרויקטים לתום הרוש

## 📋 אפיון MVP

להלן אפיון MVP מפורט עבור המערכת, מערכת ניהול פרויקטים של נדל"ן שמיועדת למשרד הראשי בלבד, המאפשרת לראות, להוסיף ולערוך פרויקטים ומשימות (כולל תתי‑משימות) בצורה פשוטה. הקונספט אינו כולל ניהול הרשאות מורכב או הקצאות משתמשים; כל הפעולות נעשות על ידי המשתמש הראשי (המשרד הראשי).

---

## 1. מבוא

### 1.1. מטרת המערכת  
- לספק ממשק פשוט ונוח למשרד הראשי שיציג את כל פרויקטי הנדל"ן של המשרד.
- לאפשר צפייה בפרויקטים עם תצוגות שונות (לוח קנבן, עץ היררכי, גאנט).
- לאפשר יצירה, עריכה וניהול פרויקטים – כולל אפשרות ליצירת פרויקט "מבוסס תבנית" שממלא אוטומטית את כל המשימות הקבועות מראש.
- לאפשר הוספה ועריכה של משימות ותתי‑משימות בתוך כל פרויקט, כולל סימון (צ׳קבוקס) של משימות קיימות לצורך ניהול וארגון.

### 1.2. קהל היעד  
- משרד ראשי – המשתמש יהיה בעל שליטה מלאה על כל הפרויקטים והמשימות הקשורות בהם.

---

## 2. רכיבי המערכת

### 2023-07-11

- שיפור בתצוגת המשימות בעמוד יצירת פרויקט חדש
- תיקון שגיאות באקורדיון הצגת המשימות
- הוספת בדיקה שהמערך `hierarchicalTasks` הוא אכן מערך לפני פעולות שונות

## 2023-07-12

- תוקנה בעיה שבה משימות נוספו גם לטבלה הראשית וגם לטבלה הספציפית של הפרויקט
- עודכנה פונקציית `cloneTasksToProject` בקובץ `src/lib/services/taskService.ts` כך שתוסיף משימות רק לטבלה הספציפית של הפרויקט
- עודכנה פונקציית `createDefaultTasksForRealEstateProject` כך שתוסיף משימות רק לטבלה הספציפית של הפרויקט
- שונתה התנהגות פונקציות הסנכרון `syncProjectTasks` בשני השירותים `taskService.ts` ו-`projectService.ts` כך שיפסיקו לסנכרן משימות לטבלה הראשית
- כל הלוגיקה העסקית עודכנה לעבוד אך ורק עם הטבלאות הספציפיות של הפרויקטים

## 2023-07-13

- נוספה מיגרציה `20250320000004_remove_duplicate_title_tasks.sql` לזיהוי ומחיקת משימות כפולות בעלות אותה כותרת
- הוספת אינדקס ייחודי `tasks_unique_title_project_idx` כדי למנוע הוספת משימות כפולות בעתיד
- נוסף טריגר `check_duplicate_title_tasks` שימנע הוספת משימות עם כותרות כפולות בעתיד
- שיפור המיגרציה כך שתתחשב בתאריך עדכון המשימה וגם בסטטוס המחיקה שלה
- התייחסות למשימות כפולות בכל טבלאות הפרויקטים הספציפיות

## 2025-03-21

- עודכן מבנה טבלת המשימות (tasks) לפי המבנה החדש הנדרש
- נוספה מיגרציה חדשה `20250321000001_tasks_restructure.sql` המבצעת את השינויים הבאים:
  - גיבוי הטבלה הקיימת ל-`tasks_backup`
  - הסרת הטבלה הקיימת ויצירתה מחדש עם השדות הנדרשים
  - השדות החדשים: `title` (שם משימה), `description` (תיאור), `project_id` (פרויקט), `stage_id` (שלב), `parent_task_id` (משימת הורה), `hierarchical_number` (מספר היררכי), `due_date` (תאריך יעד), `status` (סטטוס), `priority` (עדיפות), `category` (קטגוריה), `responsible` (אחראי), `dropbox_folder` (קישור לתקיית דרופבוקס), `created_at` (תאריך הקמה), `updated_at` (תאריך עדכון אחרון)
  - הוספת אינדקסים לשיפור ביצועים
  - יצירת טריגר לעדכון שדה `updated_at` אוטומטית בכל עדכון של המשימה
  - יצירת פונקציה וטריגר ליצירת מספר היררכי אוטומטי בעת הוספת משימה חדשה
- נוספה מיגרציה נוספת `20250321000002_tasks_data_migration.sql` המבצעת את השינויים הבאים:
  - העברת נתונים מטבלת הגיבוי `tasks_backup` לטבלה החדשה
  - העברה רק של משימות פעילות (שאינן מחוקות) ובעלות כותרת
  - השדה החדש `dropbox_folder` מאותחל כריק
  - עדכון מספרים היררכיים לכל המשימות שאין להן
- עודכן מבנה טבלת השלבים (stages) לפי המבנה החדש הנדרש
- נוספה מיגרציה חדשה `20250321000003_stages_restructure.sql` המבצעת את השינויים הבאים:
  - גיבוי הטבלה הקיימת ל-`stages_backup`
  - הסרת הטבלה הקיימת ויצירתה מחדש עם השדות הנדרשים
  - השדות החדשים: `title` (שם שלב), `hierarchical_number` (מספר היררכי), `due_date` (תאריך יעד), `status` (סטטוס), `progress` (אחוז התקדמות), `color` (צבע), `parent_stage_id` (שלב הורה), `dependencies` (תלויות), `sort_order` (סדר הצגה), `created_at` (תאריך הקמה), `updated_at` (תאריך עדכון אחרון)
  - הוספת אינדקסים לשיפור ביצועים
  - יצירת טריגר לעדכון שדה `updated_at` אוטומטית בכל עדכון של השלב
  - יצירת פונקציה וטריגר ליצירת מספר היררכי אוטומטי בעת הוספת שלב חדש
  - יצירת פונקציה וטריגר לקביעת סדר הצגה (sort_order) בעת הוספת שלב חדש
  - יצירת טבלת `stages_history` לתיעוד היסטוריית שינויים בשלבים
  - הוספת טריגרים לתיעוד אוטומטי של כל שינוי בטבלת השלבים

### טבלאות עיקריות
#### projects
```json
[
  {
    "table_name": "projects",
    "column_name": "name",
    "data_type": "text",
    "is_nullable": "NO",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "owner",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "created_at",
    "data_type": "timestamp without time zone",
    "is_nullable": "YES",
    "column_default": "now()"
  },
  {
    "table_name": "projects",
    "column_name": "updated_at",
    "data_type": "timestamp without time zone",
    "is_nullable": "YES",
    "column_default": "now()"
  },
  {
    "table_name": "projects",
    "column_name": "id",
    "data_type": "uuid",
    "is_nullable": "NO",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "status",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": "'planning'::text"
  },
  {
    "table_name": "projects",
    "column_name": "total_budget",
    "data_type": "numeric",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "planned_start_date",
    "data_type": "date",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "planned_end_date",
    "data_type": "date",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "actual_start_date",
    "data_type": "date",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "actual_end_date",
    "data_type": "date",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "project_manager_id",
    "data_type": "uuid",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "priority",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": "'medium'::text"
  },
  {
    "table_name": "projects",
    "column_name": "progress",
    "data_type": "integer",
    "is_nullable": "YES",
    "column_default": "0"
  },
  {
    "table_name": "projects",
    "column_name": "entrepreneur",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "projects",
    "column_name": "entrepreneur_id",
    "data_type": "uuid",
    "is_nullable": "YES",
    "column_default": null
  }
]
```

#### stages
```json
[
  {
    "table_name": "stages",
    "column_name": "id",
    "data_type": "uuid",
    "is_nullable": "NO",
    "column_default": "uuid_generate_v4()"
  },
  {
    "table_name": "stages",
    "column_name": "title",
    "data_type": "text",
    "is_nullable": "NO",
    "column_default": null
  },
  {
    "table_name": "stages",
    "column_name": "hierarchical_number",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "stages",
    "column_name": "due_date",
    "data_type": "date",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "stages",
    "column_name": "status",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": "'pending'::text"
  },
  {
    "table_name": "stages",
    "column_name": "progress",
    "data_type": "integer",
    "is_nullable": "YES",
    "column_default": "0"
  },
  {
    "table_name": "stages",
    "column_name": "color",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "stages",
    "column_name": "parent_stage_id",
    "data_type": "uuid",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "stages",
    "column_name": "dependencies",
    "data_type": "text[]",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "stages",
    "column_name": "sort_order",
    "data_type": "integer",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "stages",
    "column_name": "created_at",
    "data_type": "timestamp with time zone",
    "is_nullable": "YES",
    "column_default": "now()"
  },
  {
    "table_name": "stages",
    "column_name": "updated_at",
    "data_type": "timestamp with time zone",
    "is_nullable": "YES",
    "column_default": "now()"
  }
]
```

#### tasks
```json
[
  {
    "table_name": "tasks",
    "column_name": "id",
    "data_type": "uuid",
    "is_nullable": "NO",
    "column_default": "uuid_generate_v4()"
  },
  {
    "table_name": "tasks",
    "column_name": "title",
    "data_type": "text",
    "is_nullable": "NO",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "description",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "project_id",
    "data_type": "uuid",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "stage_id",
    "data_type": "uuid",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "parent_task_id",
    "data_type": "uuid",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "hierarchical_number",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "due_date",
    "data_type": "date",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "status",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": "'todo'::text"
  },
  {
    "table_name": "tasks",
    "column_name": "priority",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": "'medium'::text"
  },
  {
    "table_name": "tasks",
    "column_name": "category",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "responsible",
    "data_type": "uuid",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "dropbox_folder",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "tasks",
    "column_name": "created_at",
    "data_type": "timestamp with time zone",
    "is_nullable": "YES",
    "column_default": "now()"
  },
  {
    "table_name": "tasks",
    "column_name": "updated_at",
    "data_type": "timestamp with time zone",
    "is_nullable": "YES",
    "column_default": "now()"
  }
]
```

#### entrepreneurs
```json
[
  {
    "table_name": "entrepreneurs",
    "column_name": "id",
    "data_type": "uuid",
    "is_nullable": "NO",
    "column_default": "uuid_generate_v4()"
  },
  {
    "table_name": "entrepreneurs",
    "column_name": "name",
    "data_type": "text",
    "is_nullable": "NO",
    "column_default": null
  },
  {
    "table_name": "entrepreneurs",
    "column_name": "description",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "entrepreneurs",
    "column_name": "contact_info",
    "data_type": "text",
    "is_nullable": "YES",
    "column_default": null
  },
  {
    "table_name": "entrepreneurs",
    "column_name": "created_at",
    "data_type": "timestamp with time zone",
    "is_nullable": "YES",
    "column_default": "now()"
  },
  {
    "table_name": "entrepreneurs",
    "column_name": "updated_at",
    "data_type": "timestamp with time zone",
    "is_nullable": "YES",
    "column_default": "now()"
  }
]
```

---

## 5. זרימת עבודה (Workflow)

1. **יצירת פרויקט נדל"ן:**  
   - המשתמש בוחר באפשרות "צור פרויקט חדש" ממסך הדשבורד.
   - ישנה אפשרות לייבא פרויקט מתבנית – כאשר תבנית זו מכילה רשימת משימות מוגדרת מראש המותאמת לפרויקטי נדל"ן.
   - הפרויקט נשמר בטבלת **projects**.

2. **ניהול משימות בתוך פרויקט:**  
   - המשתמש עובר לדף הפרויקט לצפייה בכל המשימות.
   - יכול להוסיף משימה חדשה או תת‑משימה (באמצעות טופס פשוט).
   - ניתן לערוך משימות קיימות (עדכון סטטוס, תאריכים, תיאורים וכו׳).
   - תצוגות:  
     - לוח קנבן – לשינוי מהיר של סטטוסים.
     - עץ היררכי – להצגת מבנה המשימות.
     - גאנט – למעקב אחר לו"ז ותלות בין משימות.

3. **בקרה ומעקב:**  
   - דשבורד ראשי מציג סקירה של כל הפרויקטים והמשימות (כמות משימות "בפעולה", משימות שהושלמו, התקדמות כללי).
   - אפשרות לסינון וחיפוש לפי פרמטרים כמו סטטוס, תאריך יעד, עדיפות וכו׳.

---

## 6. התקדמות הפרויקט

### 🚀 שלב 1: איפוס והתחלה מחדש (10/03/2024)
- ✅ איפוס הפרויקט והגדרה מחדש של כל הקבצים
- ✅ יצירת מבנה תיקיות ראשוני
- ✅ הגדרת פרויקט Next.js עם Tailwind ו-Chakra UI

### 🚀 שלב 2: חיבור ל-Supabase
- ✅ הגדרת התחברות לשרת Supabase
- ✅ יצירת שכבת שירות לניהול מידע והתחברות
- ✅ יישום טיפוסי TypeScript למודלים
- ✅ קישור CLI של Supabase לפרויקט
- ✅ עדכון טיפוסי TypeScript לפי מבנה הטבלאות האמיתי

### 🚀 שלב 3: בניית דפי בסיס
- ✅ דף דשבורד ראשי
- ✅ דף רשימת פרויקטי נדל"ן 
- ✅ דף פרטי פרויקט
- ✅ קומפוננטת משימות ורכיבי UI משותפים

### 🚀 שלב 4: יישום תצוגות משימות
- ✅ לוח קנבן (חלקי - התחלנו אבל צריך להשלים)
- ✅ עץ היררכי
- ✅ גאנט

### 🚀 שלב 5: יישום טפסים
- ✅ טופס יצירת/עריכת פרויקט נדל"ן
- ✅ טופס יצירת/עריכת משימה
- ⬜️ תבניות פרויקטים מותאמות לנדל"ן (לא הושלם)

### 🚀 שלב 6: בדיקות ושיפורים
- ⬜️ בדיקת כל הפונקציונליות
- ⬜️ שיפורי UX/UI 
- ⬜️ אופטימיזציה וביצועים

### 🚀 שלב 7: משימות נוספות להשלמה
- ✅ השלמת תצוגת קנבן עם גרירה ושחרור
- ✅ יישום תצוגת עץ היררכי למשימות ותתי-משימות
- ✅ יישום תצוגת גאנט עם תלויות בין משימות
- ⬜️ יישום מערכת תבניות לפרויקטי נדל"ן
- ⬜️ שיפור ממשק המשתמש והוספת אנימציות
- ⬜️ הוספת פילטרים מתקדמים לחיפוש פרויקטים ומשימות
- ⬜️ יישום דשבורד אנליטיקה עם נתונים סטטיסטיים
- ⬜️ אופטימיזציה לטעינת דפים ובקשות API

### 🚀 שלב 8: עדכונים ותיקונים (11/03/2024)
- ✅ התקנת חבילות הפרויקט
- ✅ עדכון טיפוסי TypeScript לפי מבנה הטבלאות האמיתי בסופהבייס
- ✅ עדכון שירותי הפרויקט, השלבים והמשימות לעבודה עם המבנה החדש
- ✅ יישום מספרים היררכיים למשימות
- ✅ יישום תצוגת עץ משימות
- ✅ יישום תצוגת גאנט
- ✅ תיקון שגיאות בדף רשימת הפרויקטים
- ✅ התקנת חבילת @chakra-ui/icons החסרה
- ✅ הוספת אפשרות לשיוך משימות קיימות לפרויקט
- ✅ תיקון שגיאת אילוץ בעדכון סטטוס משימות (tasks_status_check)
- ✅ הוספת אפשרות ליצירת משימות ברירת מחדל בעת יצירת פרויקט חדש
- ✅ הוספת אפשרות ליצירת משימות ברירת מחדל גם בפרויקטים קיימים
- ✅ תיקון המרת סטטוס לאותיות קטנות בכל הקומפוננטות (TaskKanban, דף משימות, דף פרויקטים, דף משימה בודדת)
- ✅ תיקון ערכי הסטטוס בכל הקומפוננטות (שינוי מ-'to do', 'in progress', 'in review', 'completed' ל-'todo', 'in_progress', 'review', 'done')
- ✅ תיקון עדכון המשימה המקומית בדף המשימה הבודדת (שימוש בערך המנורמל של הסטטוס)
- ⬜️ שיפור ממשק המשתמש והוספת אנימציות
- ⬜️ הוספת פילטרים מתקדמים לחיפוש פרויקטים ומשימות
- ⬜️ יישום דשבורד אנליטיקה עם נתונים סטטיסטיים
- ⬜️ אופטימיזציה לטעינת דפים ובקשות API

### 🚀 שלב 9: שיפורים נוספים (12/03/2024)
- ✅ הוספת אפשרות לשיוך משימות קיימות לפרויקט
- ✅ יישום תצוגת קנבן מלאה עם גרירה ושחרור
- ✅ שיפור סנכרון בין תצוגות המשימות השונות (רשימה, קנבן, עץ, גאנט)
- ✅ תיקון פונקציונליות גרירה בלוח הקנבן
- ✅ שיפור תצוגת העץ ההיררכי עם קבוצות לפי שלבים ומספרים סידוריים
- ✅ תיקון שגיאת אילוץ בעדכון סטטוס משימות (tasks_status_check)
- ✅ הוספת אפשרות ליצירת משימות ברירת מחדל בעת יצירת פרויקט חדש
- ✅ הוספת אפשרות ליצירת משימות ברירת מחדל גם בפרויקטים קיימים
- ✅ תיקון המרת סטטוס לאותיות קטנות בכל הקומפוננטות (TaskKanban, דף משימות, דף פרויקטים, דף משימה בודדת)
- ✅ תיקון ערכי הסטטוס בכל הקומפוננטות (שינוי מ-'to do', 'in progress', 'in review', 'completed' ל-'todo', 'in_progress', 'review', 'done')
- ✅ תיקון עדכון המשימה המקומית בדף המשימה הבודדת (שימוש בערך המנורמל של הסטטוס)
- ⬜️ שיפור ממשק המשתמש והוספת אנימציות
- ⬜️ הוספת פילטרים מתקדמים לחיפוש פרויקטים ומשימות
- ⬜️ יישום דשבורד אנליטיקה עם נתונים סטטיסטיים
- ⬜️ אופטימיזציה לטעינת דפים ובקשות API

### 🚀 שלב 10: תיעוד ומעקב (13/03/2024)
- ✅ יצירת סקריפט אוטומטי לעדכון סכמת מסד הנתונים
- ✅ יצירת קובץ database_schema.md עם תיעוד מלא של מבנה מסד הנתונים
- ✅ עדכון כללי העבודה בפרויקט (rule.mdc) לכלול הנחיות לעדכון הסכמה
- ✅ שיפור תהליך התיעוד והמעקב אחר שינויים במסד הנתונים
- ✅ הוספת קובץ README.md עם הוראות הפעלה מפורטות
- ✅ יצירת git hook לעדכון אוטומטי של סכמת מסד הנתונים בעת commit
- ✅ הוספת פונקציות SQL לקבלת מידע על הסכמה (לשימוש עתידי)

## 🔑 פרמטרים חשובים
### Supabase
- Project Reference: `orgkbmxecoegyjojoqmh`
- Database Password: `DV55b2XoiUy3nQ4X`
- Database Host: `aws-0-eu-central-1.pooler.supabase.com`
- Database User: `postgres.orgkbmxecoegyjojoqmh`
- Database Name: `postgres`

### מידע מערכת
- OS Version: `darwin 23.4.0`
- Workspace Path: `/Users/idosegev/Downloads/TriRoars/TomHarush/tom-project`
- Shell: `/bin/zsh`

## עדכונים אחרונים

### 2024-07-XX - תיקון בעיית כפילות משימות בעת יצירת פרויקט חדש

- תוקנה בעיה שבה יצירת פרויקט חדש הייתה מכפילה את המשימות שנבחרו
- עודכנה הפונקציה `cloneTasksToProject` בקובץ `src/lib/services/taskService.ts` כך שתבדוק אם המשימות כבר קיימות בפרויקט לפני שהיא משכפלת אותן
- עודכנה הפונקציה `createDefaultTasksForRealEstateProject` בקובץ `src/lib/services/taskService.ts` כך שתבדוק אם כבר יש משימות בפרויקט לפני שהיא יוצרת משימות ברירת מחדל
- עודכנה הפונקציה `getProjectSpecificTasks` בקובץ `src/lib/services/taskService.ts` כדי לשפר את הטיפול בשגיאות ולמנוע כפילויות בהצגת המשימות

השינויים הללו מבטיחים שמשימות לא יוכפלו בעת יצירת פרויקט חדש, גם אם המשתמש בוחר גם משימות ברירת מחדל וגם משימות מותאמות אישית.

### 2024-07-XX - תיקון שגיאה בקריאה לפונקציית get_project_tasks

- נוספה פונקציה חדשה `get_tasks_tree` בקובץ `sql/project_tables.sql` שמחזירה את המשימות בצורה היררכית
- עודכנה הפונקציה `getProjectSpecificTasks` בקובץ `src/lib/services/taskService.ts` כך שתנסה קודם להשתמש בפונקציה `get_tasks_tree`, אם זו לא קיימת תנסה להשתמש ב-`get_project_tasks`, ואם גם זו לא קיימת תיפול חזרה לטבלה הראשית
- הטיפול בשגיאות שופר כך שהמערכת תמשיך לעבוד גם אם אחת הפונקציות לא קיימת

השינויים הללו מאפשרים למערכת לעבוד גם אם הפונקציה `get_project_tasks` לא קיימת או לא מוגדרת נכון בבסיס הנתונים.

### 2024-07-XX - שיפור סנכרון אוטומטי של משימות לטבלאות ספציפיות של פרויקטים

- עודכנה הפונקציה `assignTasksToProject` כך שתסנכרן אוטומטית את המשימות המשויכות לטבלה הספציפית של הפרויקט
- עודכנה הפונקציה `cloneTasksToProject` כך שתסנכרן אוטומטית את המשימות המשוכפלות לטבלה הספציפית של הפרויקט
- עודכנה הפונקציה `updateTaskHierarchy` כך שתסנכרן אוטומטית את המשימה המעודכנת לטבלה הספציפית של הפרויקט
- עודכנה הפונקציה `updateSubtaskHierarchicalNumbers` כך שתסנכרן אוטומטית את תתי-המשימות המעודכנות לטבלה הספציפית של הפרויקט
- עודכנה הפונקציה `createDefaultTasksForRealEstateProject` כך שתסנכרן אוטומטית את המשימות החדשות לטבלה הספציפית של הפרויקט

השינויים הללו מבטיחים שכל פעולה שמשנה משימות (יצירה, עדכון, מחיקה, שיוך, שכפול, שינוי היררכיה) תגרום לסנכרון אוטומטי של הטבלאות הספציפיות של הפרויקטים, כך שלא יהיה צורך להשתמש ב-API endpoint של `sync-projects` באופן שוטף.

### 2024-07-XX - הוספת תמיכה מלאה במובייל ורספונסיביות

- עודכן ה-layout הראשי של האפליקציה לתמיכה במובייל
- נוסף תפריט צד נשלף (drawer) למסכים קטנים
- עודכנו כל הדפים הראשיים להיות רספונסיביים:
  - דף הדשבורד
  - דף הפרויקטים
  - דף המשימות
  - דף היזמים
  - דף אבני הדרך
  - דף הפרויקט הבודד
  - דף המשימה הבודדת
  - דף ההתחברות
  - דף הבית
- שופרו כרטיסי הפרויקטים והמשימות לתצוגה מיטבית במובייל
- נוספו סגנונות CSS גלובליים לשיפור הרספונסיביות
- הוגדרו breakpoints מותאמים בתמת Chakra UI
- נוספו הגדרות רספונסיביות לטבלאות ולטפסים
- נוסף meta tag לתמיכה במובייל בראש האפליקציה
- עודכנו כל הקומפוננטות להשתמש בערכים רספונסיביים לגודל, מרווחים ותצוגה
- נוספו תפריטי אפשרויות (dropdown menus) במסכים קטנים במקום כפתורים מרובים
- נוספה תמיכה בגלילה אופקית לטאבים ולטבלאות במסכים קטנים
- שופרו הטפסים להתאמה למסכים קטנים עם גדלי שדות ומרווחים מותאמים
- נוספו מאפיינים רספונסיביים לכל הכותרות, טקסטים וכפתורים

השינויים הללו מאפשרים למשתמשים לגשת ולהשתמש באפליקציה מכל מכשיר, כולל טלפונים ניידים וטאבלטים, עם חוויית משתמש מיטבית המותאמת לגודל המסך.

# עדכון מצב הפרויקט

## מיגרציות שהוחלו

### פתרון בעיות בפונקציות של טבלאות הפרויקט
- [x] **20250316000000_fix_project_table_policies.sql** - תיקון הפונקציה `create_project_table` עם מדיניות אבטחה מתוקנת ושמות קצרים יותר
- [x] **20250316000001_fix_project_tasks_functions.sql** - תיקון פונקציות `get_project_tasks` ו-`get_tasks_tree` לטיפול בטבלאות פרויקט
- [x] **20250316000002_fix_project_copy_tasks.sql** - עדכון פונקציות `copy_task_to_project_table` ו-`copy_tasks_to_project_table`
- [x] **20250316000003_fix_project_sync_tasks.sql** - הוספת פונקציות `sync_project_tasks` ו-`add_tasks_to_project_table`
- [x] **20250316000004_add_original_task_id_column.sql** - הוספת עמודת `original_task_id` לטבלת tasks ועדכון פונקציות רלוונטיות
- [x] **20250316000005_fix_get_project_tasks.sql** - שיפור הפונקציות `get_project_tasks` ו-`get_tasks_tree` להוספת טיפול בשגיאות
- [x] **20250316000006_add_exec_sql_function.sql** - הוספת פונקציה `exec_sql` להרצת שאילתות SQL דינמיות
- [x] **20250316000007_fix_exec_sql_function.sql** - תיקון הפונקציה `exec_sql` לטיפול טוב יותר בתוצאות
- [x] **20250316000008_fix_sync_project_tasks.sql** - תיקון הפונקציה `sync_project_tasks` לפתרון בעיית עמודה דו-משמעית
- [x] **20250316000009_fix_copy_task_to_project_table.sql** - תיקון הפונקציה `copy_task_to_project_table` לפתרון בעיית עמודה דו-משמעית
- [x] **20250316000010_fix_sync_project_tasks_again.sql** - שיפור נוסף בפונקציה `sync_project_tasks` עם שימוש בפרמטרים יחודיים
- [x] **20250316000011_fix_exec_sql_function_again.sql** - שיפור הפונקציה `exec_sql` לטיפול בתוצאות מרובות
- [x] **20250316000012_add_is_template_column.sql** - הוספת עמודת `is_template` לטבלת tasks
- [x] **20250316000013_fix_create_project_table.sql** - עדכון פונקציית `create_project_table` לתמיכה בעמודות החדשות
- [x] **20250316000014_fix_copy_task_to_project_table_again.sql** - שיפור הפונקציה `copy_task_to_project_table` עם ציון מפורש של עמודות וערכים
- [x] **20250316000015_fix_copy_task_to_project_table_final.sql** - תיקון סופי לפונקציה `copy_task_to_project_table` לטיפול במקרי קצה
- [x] **20250316000016_fix_sync_project_tasks_final.sql** - תיקון סופי לפונקציה `sync_project_tasks`

### טיפול בטבלת יזמים (Entrepreneurs)
- [x] **20250317000000_create_entrepreneurs_table.sql** - יצירת טבלת היזמים
- [x] **20250317000002_disable_entrepreneurs_rls_fix.sql** - ביטול ה-RLS בטבלת היזמים והסרת מדיניויות אבטחה
- [x] **20250317000003_grant_access_to_entrepreneurs.sql** - הענקת הרשאות גישה לטבלת היזמים לכל התפקידים

## שיפורים שהוטמעו

### ניהול טבלאות פרויקט
1. **פתרון בעיית העמודה הדו-משמעית** - תיקנו את הבעיה עם `project_id` שהיה דו-משמעי בפונקציות שונות.
2. **טיפול בשגיאות** - הוספנו טיפול בשגיאות לפונקציות העיקריות כמו `get_project_tasks` ו-`get_tasks_tree`.
3. **עמודת `original_task_id`** - הוספנו עמודה זו כדי לאפשר מעקב אחר המשימה המקורית בעת העתקת משימות בין פרויקטים.
4. **עמודת `is_template`** - הוספנו עמודה זו לסימון משימות תבנית.

### פונקציית `exec_sql`
- הוספנו פונקציה זו שמאפשרת הרצת שאילתות SQL דינמיות ומחזירה תוצאות בפורמט JSON.
- שיפרנו את הפונקציה כדי שתתמוך בתוצאות מרובות ובטיפול מתאים בשגיאות.

### טבלת היזמים
1. **יצירת הטבלה** - יצרנו את טבלת היזמים עם העמודות הנדרשות.
2. **ביטול RLS** - ביטלנו את ה-RLS (Row Level Security) בטבלה כדי לאפשר גישה לכל המשתמשים.
3. **הסרת מדיניויות** - הסרנו את כל מדיניויות האבטחה שהגבילו את הגישה לטבלה.
4. **הענקת הרשאות** - הענקנו הרשאות מלאות לכל התפקידים (anon, authenticated, service_role) לטבלה.

## סטטוס נוכחי
- [x] המערכת מאפשרת סנכרון משימות בין הטבלה הראשית לטבלת הפרויקט הספציפית.
- [x] פתרנו את כל הבעיות עם עמודות `is_template` ו-`original_task_id` בכל הפונקציות הרלוונטיות.
- [x] פונקציית `exec_sql` פועלת בצורה תקינה ומאפשרת הרצת שאילתות דינמיות.
- [x] טבלת היזמים נגישה לכל המשתמשים, כולל משתמשים אנונימיים (anon).
- [x] ניתן לקרוא ולכתוב נתונים לטבלת היזמים ללא שגיאות הרשאה.
- [x] הסרנו את כל מדיניויות ה-RLS מכל הטבלאות במערכת.
- [x] בדקנו את פונקציית `sync_project_tasks` והיא פועלת כהלכה.
- [x] ניתן להוסיף משימות חדשות ישירות לטבלאות פרויקטים ספציפיות עם SQL.

## צעדים הבאים
- [ ] בחינה מקיפה של כל פונקציות הפרויקט לאיתור בעיות נוספות.
- [ ] שיפור הממשק להוספת וניהול יזמים.
- [ ] הוספת יכולות דוחות מתקדמות למשימות ופרויקטים.
- [ ] שיפור התמיכה במשימות תבנית ושכפול משימות בין פרויקטים.
- [ ] תיקון פונקציות `add_tasks_to_project_table` ו-`get_project_tasks` לפעולה תקינה.
- [ ] בדיקת כל הפונקציות שמשתמשות בטבלאות פרויקט ספציפיות ווידוא פעולתן התקינה.

### 2024-03-18 - הסרת מדיניות RLS מכל הטבלאות במערכת

- [x] **20250318000000_disable_all_rls.sql** - ביטול RLS והסרת כל מדיניויות האבטחה מכל הטבלאות במערכת
- [x] **20250318000001_update_create_project_table_no_rls.sql** - עדכון פונקציית `create_project_table` להסרת הגדרות RLS
- [x] **20250318000002_disable_all_project_tables_rls.sql** - ביטול RLS מטבלאות פרויקטים ספציפיות באופן מפורש
- [x] **20250318000003_remove_remaining_policies.sql** - הסרת המדיניויות (policies) הנותרות מהטבלאות

#### שינויים שבוצעו:
- ביטלנו את ה-RLS מכל הטבלאות הראשיות: `entrepreneurs`, `projects`, `tasks`, `stages`
- הסרנו את כל המדיניויות (policies) מכל הטבלאות
- ביטלנו את ה-RLS מכל טבלאות הפרויקטים הספציפיות (`project_*_tasks`)
- עדכנו את פונקציית `create_project_table` כך שלא תגדיר RLS בטבלאות חדשות
- הענקנו הרשאות גישה מלאות לכל הטבלאות עבור כל התפקידים (anon, authenticated, service_role)

#### בדיקות שבוצעו:
- בדקנו גישה לקריאת נתונים מכל הטבלאות הראשיות ומטבלאות פרויקט ספציפיות
- בדקנו את פונקציית `sync_project_tasks` שמסנכרנת משימות מהטבלה הראשית לטבלה הספציפית של הפרויקט
- בדקנו הוספת משימות חדשות לטבלת פרויקט ספציפית באמצעות SQL ישיר
- ווידאנו שאין שגיאות הרשאה בגישה לטבלאות

#### ממצאים:
- פונקציית `sync_project_tasks` פועלת כראוי ומסנכרנת משימות מהטבלה הראשית לטבלה הספציפית של הפרויקט
- ניתן להוסיף משימות חדשות ישירות לטבלאות פרויקט ספציפיות באמצעות SQL
- פונקציית `add_tasks_to_project_table` עדיין מחזירה שגיאה בפורמט ה-JSON
- פונקציית `get_project_tasks` מחזירה שגיאה בגלל אי התאמה במבנה התוצאה

#### המלצות:
1. להמשיך להשתמש בפונקציית `sync_project_tasks` לסנכרון משימות
2. להשתמש בשאילתות SQL ישירות או בקריאות לטבלה דרך ה-API להוספת משימות חדשות
3. לבדוק ולתקן את פונקציות `add_tasks_to_project_table` ו-`get_project_tasks` בעתיד

### 2024-03-19 - טיפול בכפילויות משימות

- [x] **20250319000000_remove_duplicate_tasks.sql** - מחיקת כפילויות משימות לפי כותרת בטבלת המשימות הראשית ובטבלאות הספציפיות של פרויקטים

#### שינויים שבוצעו:
- זיהוי משימות כפולות לפי כותרת (title) ופרויקט (project_id)
- שמירת המשימה החדשה מכל קבוצת משימות כפולות ומחיקה לוגית של השאר (הגדרת deleted=true)
- טיפול בכפילויות גם בטבלאות הספציפיות של פרויקטים
- הוספת אינדקסים על שדה title ועל השילוב של title ו-project_id
- יצירת טריגר prevent_duplicate_tasks שירשום התראה בניסיון להוסיף משימה כפולה

#### יתרונות הפתרון:
1. **מחיקה לוגית במקום פיזית** - המשימות הכפולות מסומנות כמחוקות אך נשמרות במסד הנתונים למקרה שנצטרך לשחזר אותן
2. **תיעוד מלא** - כל המשימות שנמחקו מתועדות עם פרטים מלאים
3. **טיפול מקיף** - מטפל גם בטבלאות הספציפיות של פרויקטים
4. **מניעה עתידית** - הטריגר ימנע יצירת כפילויות חדשות
5. **ביצועים משופרים** - האינדקסים החדשים משפרים את ביצועי החיפוש לפי כותרת

## צעדים הבאים
- [ ] בדיקת יעילות הטריגר למניעת כפילויות
- [ ] בחינה מקיפה של כל פונקציות הפרויקט לאיתור בעיות נוספות.
- [ ] שיפור הממשק להוספת וניהול יזמים.
- [ ] הוספת יכולות דוחות מתקדמות למשימות ופרויקטים.
- [ ] שיפור התמיכה במשימות תבנית ושכפול משימות בין פרויקטים.
- [ ] תיקון פונקציות `add_tasks_to_project_table` ו-`get_project_tasks` לפעולה תקינה.
- [ ] בדיקת כל הפונקציות שמשתמשות בטבלאות פרויקט ספציפיות ווידוא פעולתן התקינה.

### 2024-03-19 - תיקון בעיית מחיקת פרויקטים

- [x] **fix_delete_project_simple.sql** - תיקון בעיית מחיקת פרויקטים: הוספת מחיקה מסוג CASCADE
- [x] **force_delete_project_function.sql** - יצירת פונקציה מיוחדת למחיקת פרויקטים מאולצת

#### שינויים שבוצעו:
- הסרת מגבלות זרות (foreign keys) קיימות בטבלאות tasks ו-stages והחלפתן במגבלות חדשות עם אפשרות ON DELETE CASCADE
- עדכון הטריגר before_delete_project לפעולה תקינה
- יצירת פונקציה ייעודית force_delete_project שמבצעת מחיקה בצורה מסודרת ומאולצת של כל הישויות הקשורות לפרויקט
- עדכון שירות projectService כדי להשתמש בפונקציה החדשה למחיקת פרויקטים

#### יתרונות הפתרון:
1. **מחיקה מקיפה** - פרויקטים נמחקים כעת יחד עם כל הרשומות המקושרות אליהם באופן אוטומטי
2. **פתרון עמיד** - גם אם קיימות מגבלות דינמיות לא צפויות, הפונקציה המאולצת מבטיחה מחיקה מלאה
3. **תהליך מסודר** - מחיקת הישויות המקושרות לפני מחיקת הפרויקט עצמו
4. **תמיכה חזקה בשגיאות** - טיפול בשגיאות וניסיון חלופי אם הפונקציה המאולצת נכשלת
5. **שיפור חוויית משתמש** - המשתמשים יכולים למחוק פרויקטים ללא שגיאות

## צעדים הבאים
- [ ] בדיקת יעילות הטריגר למניעת כפילויות
- [ ] בחינה מקיפה של כל פונקציות הפרויקט לאיתור בעיות נוספות
- [ ] שיפור הממשק להוספת וניהול יזמים
- [ ] הוספת יכולות דוחות מתקדמות למשימות ופרויקטים
- [ ] שיפור התמיכה במשימות תבנית ושכפול משימות בין פרויקטים
- [ ] תיקון פונקציות `add_tasks_to_project_table` ו-`get_project_tasks` לפעולה תקינה
- [ ] בדיקת כל הפונקציות שמשתמשות בטבלאות פרויקט ספציפיות ווידוא פעולתן התקינה
- [ ] בדיקה מקיפה של פונקציית מחיקת פרויקטים ווידוא שאין בעיות נוספות

## 05/07/2024

### שיפורים בעץ משימות
- עודכן הרכיב `TaskTree.tsx` כדי לשפר את הלוגיקה שבונה את עץ המשימות ההיררכי
- שופרה הלוגיקה למיון משימות על פי מספר היררכי או לפי תאריך יצירה
- תוקנה הצגת תתי-משימות בעץ ההיררכי והוספה בדיקה שתמנע כפילויות בעץ
- התווספה התראת הצלחה בעת יצירת תת-משימה
- המשימות עכשיו מוצגות בצורה פתוחה כברירת מחדל להגדלת שימושיות המערכת
- נוספה תמיכה במצב מסונן (כאשר מחפשים משימות ספציפיות)
- כאשר נוצרת תת-משימה חדשה, המשימה האב מורחבת אוטומטית לחשיפת התת-משימה החדשה

### שיפורים והתאמות נוספות
- טופלו השגיאות בפונקציה `createDefaultTasksForRealEstateProject` כדי שתתמוך ב-`stageId` שיכול להיות `null`
- שופרה הלוגיקה בדף יצירת הפרויקט החדש כדי לטפל במקרים שבהם אין שלבים קיימים
- עודכנה לוגיקת יצירת שלב ברירת מחדל כשלא קיימים שלבים

## 19-03-2025: תיקוני באגים - פונקציונליות פרויקטים, משימות ויזמים

### באגים שתוקנו:

1. **בעיית הוספת משימות לפרויקט**:
   - תוקנה בעיה שמנעה הוספת משימות לפרויקט חדש
   - שופרה פונקציית `assignTasksToProject` בשירות המשימות
   - הוספת טיפול טוב יותר בשגיאות ויצירת טבלאות ייחודיות לפרויקט אם הן לא קיימות

2. **בעיית שמירת שם היזם בעריכת הפרויקט**:
   - תוקנה בעיה בפונקציית עדכון הפרויקט שלא שמרה את שם היזם כראוי
   - הוספת קוד שמשלים את שם היזם אוטומטית לפי המזהה שנבחר
   - עתה הפרויקט מציג כראוי את שם היזם בכל המקומות

3. **בעיית ניווט לדשבורד של יזם ספציפי**:
   - תוקנה בעיה שהובילה לכך שלחיצה על "צפה בדשבורד" בדף היזמים הובילה לדשבורד כללי
   - שופר מנגנון טעינת היזמים בדשבורד
   - הוספת תמיכה בפרמטר URL `entrepreneur` לסינון אוטומטי של דשבורד לפי יזם ספציפי
   - עדכון ה-URL בעת שינוי היזם הנבחר לאפשר שיתוף/שמירה של תצוגת דשבורד מסוננת

### שיפורים נוספים:

- שיפור טיפול בשגיאות בכל הפונקציות שתוקנו
- הוספת הודעות לוג מפורטות יותר לצורכי ניפוי באגים
- שימוש עקבי ב-entrepreneur_id בכל חלקי האפליקציה

## 2024-03-21 - שיפור חווית משתמש בתפריטי הבחירה

- שופרה התנהגות תפריטי הבחירה בכל הקומפוננטות המרכזיות במערכת
- התווספה פונקציונליות שמסירה את הפוקוס (blur) לאחר בחירה בתפריט
- העדכון בוצע בקבצים הבאים:
  - `src/app/dashboard/projects/[id]/edit/page.tsx` - תפריטי הבחירה בדף עריכת פרויקט
  - `src/app/dashboard/page.tsx` - תפריט בחירת יזם בדשבורד
  - `src/app/dashboard/tasks/page.tsx` - תפריטי סינון בדף המשימות
  - `src/components/tasks/TaskEditModal.tsx` - תפריטי הבחירה במודל עריכת משימות
  - `src/components/tasks/TaskTree.tsx` - תפריט שינוי סטטוס בעץ המשימות
  - `src/components/tasks/TaskTemplateButton.tsx` - תפריט בחירת תבניות משימות

#### יתרונות השיפור:
1. **חווית משתמש משופרת** - תפריטי הבחירה נסגרים מיד לאחר שהמשתמש בוחר פריט, ללא צורך בלחיצה נוספת
2. **מניעת מצבים בעייתיים** - מניעת מקרים בהם התפריט נשאר פתוח ותופס מקום ומסתיר אלמנטים אחרים
3. **התנהגות עקבית** - כל תפריטי הבחירה במערכת מתנהגים באופן עקבי ואחיד
4. **נגישות משופרת** - משפר את הנגישות במכשירים ניידים ובשימוש במקלדת

השינויים שומרים על פונקציונליות מלאה של תפריטי הבחירה תוך שיפור חווית המשתמש.

## 20/03/2024 - הוספת קובץ SQL להזנת שלבים A-E ומשימות a-z

נוצר קובץ חדש בשם `sql/insert_stages_tasks.sql` שמוסיף:
- 5 שלבים (Stage A עד Stage E) עם מאפיינים שונים כגון צבע וסטטוס התחלתי
- 26 משימות (Task a עד Task z) המקושרות לשלבים השונים
- כל משימה מקבלת מאפיינים כמו סטטוס, עדיפות ומספר היררכי
- קיים עדכון של סטטוס וקידום השלבים בהתאם למשימות המקושרות אליהם

כדי להריץ את הקובץ:
```
node run_sql.js sql/insert_stages_tasks.sql
```

## 20/03/2024 - הוספת קובץ SQL להזנת שלבים ומשימות עם מספרים היררכיים

נוצר קובץ חדש בשם `sql/insert_numeric_stages_tasks.sql` שמוסיף:
- 5 שלבים (שלב 1 עד שלב 5) עם מספרים היררכיים (1, 2, 3, 4, 5)
- משימות ראשיות עם מספרים היררכיים (1.1, 1.2, ..., 5.5)
- תת-משימות ברמה שנייה (1.1.1, 1.1.2, ...)
- תת-משימות ברמה שלישית (1.1.1.1, 1.1.1.2, ...)

המבנה ההיררכי משקף את הדרישה החדשה להיררכיה מספרית, לדוגמה:
- שלב 1
  - משימה 1.1
    - משימה 1.1.1
      - משימה 1.1.1.1
      - משימה 1.1.1.2
    - משימה 1.1.2
    - משימה 1.1.3
  - משימה 1.2
  - ... וכן הלאה

כדי להריץ את הקובץ:
```
node run_sql.js sql/insert_numeric_stages_tasks.sql
```

## 20/03/2024 - תיקון שימוש בטבלאות ספציפיות של פרויקט לשמירת משימות

בוצעו מספר שינויים כדי להבטיח שמשימות פרויקט יישמרו אך ורק בטבלה הייעודית של הפרויקט ולא בטבלה הכללית:

1. **עדכון פונקציית `cloneTasksToProject`**:
   - תוקנה בדיקת משימות כפולות כך שתבדוק בטבלה הספציפית של הפרויקט במקום בטבלה הכללית
   - שיפור הודעות לוג כדי לציין מפורשות שמדובר בטבלה הספציפית

2. **עדכון פונקציית `getHierarchicalTasks`**:
   - שינוי כך שתשתמש קודם כל בטבלה הספציפית של הפרויקט
   - שימוש בטבלה הכללית רק כפתרון לתאימות לאחור במקרה שהטבלה הספציפית לא קיימת

3. **עדכון פונקציית `countTasksInProject`**:
   - שינוי כך שתספור משימות מהטבלה הספציפית של הפרויקט
   - שימוש בטבלה הכללית רק כפתרון לתאימות לאחור במקרה שהטבלה הספציפית לא קיימת

שינויים אלה יבטיחו שבעת יצירת פרויקט חדש או הוספת משימות לפרויקט קיים, המשימות יישמרו רק בטבלה הייעודית של הפרויקט ולא בטבלת המשימות הכללית.

השינויים משפרים את ביצועי המערכת, מפחיתים את העומס על טבלת המשימות הכללית, ומונעים בעיות של מידע כפול ולא מסונכרן.
