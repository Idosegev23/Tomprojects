-- מיגרציה ליצירת משימות חדשות ושיוכן לשלבים החדשים
-- תאריך: 20-03-2025

-- בדיקה שהשלבים החדשים קיימים
DO $$
DECLARE
  stages_count INTEGER;
BEGIN
  SELECT count(*) INTO stages_count FROM stages;
  
  IF stages_count < 6 THEN
    RAISE EXCEPTION 'חסרים שלבים במערכת. יש ליצור את ששת השלבים החדשים לפני הרצת מיגרציה זו.';
  END IF;
END $$;

-- יצירת המשימות החדשות ושיוכן לשלבים המתאימים
INSERT INTO tasks (
  id, title, description, category, status, priority, 
  stage_id, created_at, updated_at, deleted
) VALUES
  -- שלב התנעה והקמה
  (uuid_generate_v4(), 'שיחת היכרות עם החברה ופועלה', 'רקע יחודי להיכרות הפרויקט', 'תפעול', 'לא התחילה', 'high', 
   '00000001-0000-0000-0000-000000000001', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'תהליך שיווק ומכירות קיים אצל היזם', 'תיאום ציפיות ובניית אסטרטגייה', 'שיווק', 'לא התחילה', 'high', 
   '00000001-0000-0000-0000-000000000001', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הקמת פרויקט במערכת / דרופבוקס', 'שליחת צ''קליסט ליזם להעלאת חומרים', 'תפעול', 'לא התחילה', 'high', 
   '00000001-0000-0000-0000-000000000001', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'שיחה עם אדירכל הפרויקט', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000001-0000-0000-0000-000000000001', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'שיחת הכרות עם צוות הביצוע', 'שינויי דיירים', 'תפעול', 'לא התחילה', 'medium', 
   '00000001-0000-0000-0000-000000000001', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'שיחת הכרות עם משרד עורכי הדין המלוים', null, 'משפטי', 'לא התחילה', 'medium', 
   '00000001-0000-0000-0000-000000000001', NOW(), NOW(), false),
   
  -- שלב תכנון ואישורים
  (uuid_generate_v4(), 'תכניות הדירות', 'כל דירה בנפרד עם מספר דירה, עדיפות לקבצי DWF או PDF', 'תפעול', 'לא התחילה', 'high', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'טבלת דירות', 'לפי מספר, קומה, טיפוס, שטחים, הצמדות (חניות ומחסנים), כיוון, עם הערכת השמאי בדו"ח אפס', 'תפעול', 'לא התחילה', 'high', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'תכניות מכירה צבועות', 'תצבענה על בסיס תכנית מכר ותכלולנה העמדה של הדירה בקומה, מספר קומה (חתך), מספר דירה, שטחים', 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: החלטת ועדה בתנאים', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: בקרת תכן והשלמת תנאים', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: התקבל היתר', null, 'תפעול', 'לא התחילה', 'high', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: הריסה', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: דיפון וחפירה', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: גמר יסודות', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: גמר מרתף', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: גמר שלד', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: גמר בניה', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: חיבורי תשתיות', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סטטוס פרויקט: קבלת טופס אכלוס', null, 'תפעול', 'לא התחילה', 'high', 
   '00000002-0000-0000-0000-000000000002', NOW(), NOW(), false),
  
  -- שלב תפעול ולוגיסטיקה
  (uuid_generate_v4(), 'רשימת אנשי קשר בחברה', 'טלפון ומייל, יועצים וספקים לפרויקט (מצורפת טבלה)', 'תפעול', 'לא התחילה', 'medium', 
   '00000003-0000-0000-0000-000000000003', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'מפרט טכני', 'או עיקרי המפרט במידה ואין מפרט מלא - להבליט אלמנטים ייחודיים בפרויקט שנותנים ערך במכירה', 'תפעול', 'לא התחילה', 'high', 
   '00000003-0000-0000-0000-000000000003', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'נוהל תקשורת והעברת נתונים', '(יש/אין)', 'תפעול', 'לא התחילה', 'medium', 
   '00000003-0000-0000-0000-000000000003', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'נוהל טיפול בצ''ק הרשמה', null, 'תפעול', 'לא התחילה', 'high', 
   '00000003-0000-0000-0000-000000000003', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'כתובת דוא"ל + מספר טלפון יזם לאיש מכירות', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000003-0000-0000-0000-000000000003', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'משרד מכירות', 'גישה למקום, חניה, נוהל אירוח לקוח, תפעול סביבת עבודה (וויפיי, מדפסת, קופה קטנה)', 'תפעול', 'לא התחילה', 'high', 
   '00000003-0000-0000-0000-000000000003', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'תנאי וסביבת עבודה רצויה להצלחה', 'ריהוט, כיבוד, מסך, צמחיה', 'תפעול', 'לא התחילה', 'medium', 
   '00000003-0000-0000-0000-000000000003', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'ביקור בדירה לדוגמה', null, 'תפעול', 'לא התחילה', 'medium', 
   '00000003-0000-0000-0000-000000000003', NOW(), NOW(), false),
  
  -- שלב שיווק ומיתוג
  (uuid_generate_v4(), 'סקר שוק ומתחרים', 'מתעדכן רבעונית (תזכורות)', 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'עדכון רבעוני של הסקר', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'קריאייטיב', 'עובד חברה או חברה חיצונית. פרטי התקשרות (לגייס מישהו כזה או יש כבר?)', 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'עיצוב גרפי', 'עובד חברה או חברה חיצונית. פרטי התקשרות', 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'קופירייטר', 'עובד חברה או חברה חיצונית. פרטי התקשרות', 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'עמוד עיסקי', 'הרשאת מנהל מודעות והקמת חשבון אליו יגיעו הלידים', 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'עיצוב חוברת פרויקט', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הדפסת חוברת פרויקט', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'חוברת פרויקט דיגיטלית למשלוח', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הדמיות', 'חוץ (קדמי אחורי יום ובין ערביים/לילה), פנים דירות מיוחדות חלל מרכזי + מדגם מטיפוסיות + חלל ציבורי/לובי', 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'עיצוב פרוספקט תכניות מכירה לפרויקט', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הדפסת פרוספקט תכניות מכירה', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סיורים וירטואליים לפי בחירה', 'גן, פנטהאוס, 2 טיפוסים', 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'צילום רחפן ו/או 360', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הפעלת עמוד מדל"ן + יד 2', null, 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הקמת עמוד מדלן', null, 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הקמת עמוד יד 2', null, 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'קמפיינר', 'מפעיל קמפיין בסושיאל (פייסבוק/אינסטגרם/מיניסייט/גוגל/כתבות תוכן)', 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הקמת קמפיין גוגל וGDN', null, 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'גרפיקות לשלט פרויקט ו/או חומה מדברת', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'מיניסייט על בסיס חומרי השיווק', 'כולל טופס השארת פרטים מתממשק לCRM', 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'חברת דפוס', null, 'שיווק', 'לא התחילה', 'low', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'עיצוב חומה מדברת', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'ביצוע חומה מדברת', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'וידאו לסושיאל מצולם וערוך לREELS', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'פריסת תקציב חודשית לפרסום', null, 'שיווק', 'לא התחילה', 'high', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'אוטומציה ומסע לקוח מלאים', null, 'שיווק', 'לא התחילה', 'medium', 
   '00000004-0000-0000-0000-000000000004', NOW(), NOW(), false),
  
  -- שלב מכירות וליווי לקוחות
  (uuid_generate_v4(), 'סקר שוק עצמי של מנהל המכירות והיכרות של הנתונים', null, 'מכירות', 'לא התחילה', 'high', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'בקיאות מנהל המכירות בתכניות ובסביבת הפרויקט', null, 'מכירות', 'לא התחילה', 'high', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'בקיאות מנהל המכירות בעזרי הפרויקט', null, 'מכירות', 'לא התחילה', 'medium', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'בקיאות מנהל המכירות בתנאי מימון והתנהלות פיננסית', 'סימולציה', 'מכירות', 'לא התחילה', 'high', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'שינויי דיירים', 'פרטי התקשרות ונוהל התייעצות ועבודה', 'מכירות', 'לא התחילה', 'medium', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'מערכת CRM', 'הקמת 3 משתמשים (יזם, מנהל מכירות/תפעול, איש מכירות)', 'מכירות', 'לא התחילה', 'high', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), '3 שלוחות/מספרים לפחות', 'שלט פרויקט, מיניסייט, שלטי חוצות', 'מכירות', 'לא התחילה', 'medium', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'התקשרות עם מדלן ויד 2', 'מימשוק למערכת CRM כולל מספרים וצביעת מקור הגעה', 'מכירות', 'לא התחילה', 'high', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'בוט ווטסאפ', 'מספר ייעודי של החברה ממומשק למערכת CRM', 'מכירות', 'לא התחילה', 'medium', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'מוצרי קד"מ', 'שקית, פולדר, מתנה, וואוצ''ר, עציץ, יין', 'מכירות', 'לא התחילה', 'medium', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'קאפה/רולאפ הפרויקט + לוח מכירות למשרד', null, 'מכירות', 'לא התחילה', 'medium', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'אירועי מכירות', 'הריסה, אבן פינה, אמצע מכירות, דירות אחרונות, מסירת פרויקט', 'מכירות', 'לא התחילה', 'medium', 
   '00000005-0000-0000-0000-000000000005', NOW(), NOW(), false),
  
  -- שלב משפטי ופיננסי
  (uuid_generate_v4(), 'דרך תחשיב אפשרויות התשלום', 'סוגי הפריסות והסבסוד', 'פיננסי', 'לא התחילה', 'high', 
   '00000006-0000-0000-0000-000000000006', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'הסכמים', 'טופס הרשמה, חוזים, מכר', 'משפטי', 'לא התחילה', 'high', 
   '00000006-0000-0000-0000-000000000006', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'סקירת נקדות תורפה בהסכמים', 'לדוגמא: פרעון, נאמנות, ליווי, רישוי', 'משפטי', 'לא התחילה', 'high', 
   '00000006-0000-0000-0000-000000000006', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'בנק מלווה', 'היכרות מי הגוף המממן, עיקרי הסכם הליווי מבחינת יעדים ובניית תכנית עבודה', 'פיננסי', 'לא התחילה', 'high', 
   '00000006-0000-0000-0000-000000000006', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'חברת ייעוץ פיננסי לרוכשים', null, 'פיננסי', 'לא התחילה', 'medium', 
   '00000006-0000-0000-0000-000000000006', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'נוהל תקשורת מול העו"ד המלווה + פגישת היכרות', null, 'משפטי', 'לא התחילה', 'high', 
   '00000006-0000-0000-0000-000000000006', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'מימון חוץ בנקאי והלוואות משלימות לרוכשים', null, 'פיננסי', 'לא התחילה', 'medium', 
   '00000006-0000-0000-0000-000000000006', NOW(), NOW(), false),
   
  (uuid_generate_v4(), 'שיחת הערות עם חברת משכנתאות מלווה ככל ויש', null, 'פיננסי', 'לא התחילה', 'medium', 
   '00000006-0000-0000-0000-000000000006', NOW(), NOW(), false)
;

-- הוספת תגיות למשימות בהתאם לקטגוריה שלהן
UPDATE tasks SET labels = ARRAY[category] WHERE labels IS NULL; 