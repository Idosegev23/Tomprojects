# פתרון לשגיאה: "cannot change return type of existing function"

## הבעיה

בפרויקט התרחשה שגיאה בעת ניסיון להתקין את הפונקציה `get_project_tasks` עם סוג החזרה שונה מהקיים. השגיאה הייתה:
```
ERROR: 42P13: cannot change return type of existing function
```

## הפתרון

הבעיה נבעה מהעובדה שהפונקציה `get_project_tasks` הייתה מוגדרת מראש עם סוג החזרה אחד (`SETOF tasks`) ובקובץ המיגרציה החדש ניסינו ליצור אותה עם סוג החזרה אחר (`SETOF TABLE...`). פתרנו את הבעיה על ידי:

1. מחיקת הפונקציה הקיימת באמצעות `DROP FUNCTION` לפני יצירתה מחדש.
2. עדכון ההגדרה של הפונקציה כך שתחזיר את אותו סוג נתונים (`SETOF tasks`).
3. הוספת טיפול שגיאות (exception handling) כדי להתמודד עם מקרים של טבלאות חסרות.

הקבצים שעודכנו:

1. `supabase/migrations/20250410000000_create_project_triggers.sql`: עדכון הגדרת הפונקציות `get_project_tasks` ו-`get_tasks_tree`.
2. `scripts/init_project_function.sql`: עדכון הגדרת הפונקציות ושינוי הלוגיקה כך שהפונקציה תיצור את הטבלאות אם הן לא קיימות במקום לזרוק שגיאה.

## בדיקת שהפתרון עובד

כדי לבדוק שהפתרון עובד ושהפונקציות מותקנות כראוי:

1. הריצו את הסקריפט `scripts/fix_all_issues.mjs` באמצעות:
   ```
   node scripts/fix_all_issues.mjs
   ```

2. בדקו את תקינות הפונקציות באמצעות הרצת הסקריפט `scripts/verify_functions.sql` בממשק ה-SQL של סופאבייס.

3. צרו פרויקט חדש כדי לוודא שהטריגר ליצירת טבלאות ייחודיות לפרויקט עובד.

## הערות נוספות

- שימו לב שיש חוסר התאמה בין מבנה טבלת `tasks` במסד הנתונים למה שמצופה על ידי הפונקציות. הפונקציות מצפות לשדה `deleted` שלא קיים בטבלה.
  
- בפונקציית `init_project_tables_and_data` הוספנו אפשרות ליצור את הטבלאות אוטומטית אם הן לא קיימות, מה שמשפר את העמידות של המערכת.

- הטריגר שהוספנו ליצירת טבלאות אוטומטית כאשר נוצר פרויקט חדש מבטיח שהמערכת תעבוד באופן חלק יותר בעתיד.

אם עדיין נתקלים בבעיות, ייתכן שיהיה צורך להתאים את מבנה הטבלאות הספציפיות לפרויקט או את טבלת `tasks` כך שיתאימו להגדרות הפונקציות. 