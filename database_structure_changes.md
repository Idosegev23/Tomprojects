# שינויים במבנה מסד הנתונים למערכת ניהול הפרויקטים

## סקירה כללית

המערכת עוברת שינוי מבני בבסיס הנתונים כדי לתמוך בהיררכיה חדשה של ניהול המשימות והפרויקטים. המבנה החדש יכלול את הרמות הבאות:

1. **יזמים** - הרמה הגבוהה ביותר, אחראית על פרויקטים רבים.
2. **פרויקטים** - פרויקטים השייכים ליזמים.
3. **אבני דרך / שלבים** - חלוקת הפרויקט לשלבים עיקריים.
4. **משימות** - משימות הקשורות לאבני דרך ספציפיות.
5. **תתי משימות (מתוכננות)** - תת משימות מתוכננות מראש.
6. **תתי תתי משימות (אד הוק)** - משימות אד-הוק שנוצרות במהלך הפרויקט.

## רשימת אבני הדרך הקבועות

1. היכרות
2. איסוף חומר קיים
3. השלמות
4. הערות
5. יישור קו
6. עלייה לאוויר (פריסייל)
7. איסוף נתונים ועדכון
8. המשך מכירות
9. תוך כדי בניה
10. מסירות

## טבלאות חדשות והקשרים ביניהן

### 1. טבלת יזמים (entrepreneurs)

טבלה זו כבר קיימת במערכת ומכילה את פרטי היזמים.

| שדה | סוג נתונים | תיאור |
|-----|------------|-------|
| id | uuid | מזהה ייחודי |
| name | text | שם היזם |
| description | text | תיאור |
| contact_info | text | פרטי קשר |
| created_at | timestamptz | תאריך יצירה |
| updated_at | timestamptz | תאריך עדכון |

### 2. טבלת פרויקטים (projects)

טבלת הפרויקטים לוקחת את המבנה הקיים ומוסיפה שדות חדשים.

| שדה | סוג נתונים | תיאור |
|-----|------------|-------|
| id | uuid | מזהה ייחודי |
| name | text | שם הפרויקט |
| description | text | תיאור |
| entrepreneur_id | uuid | מזהה היזם (מפתח זר) |
| status | text | סטטוס הפרויקט |
| priority | text | עדיפות |
| department | text | מחלקה |
| responsible | uuid | אחראי |
| total_budget | numeric | תקציב כולל |
| planned_start_date | date | תאריך התחלה מתוכנן |
| planned_end_date | date | תאריך סיום מתוכנן |
| actual_start_date | date | תאריך התחלה בפועל |
| actual_end_date | date | תאריך סיום בפועל |
| progress | integer | התקדמות באחוזים |
| created_at | timestamptz | תאריך יצירה |
| updated_at | timestamptz | תאריך עדכון |

### 3. טבלת אבני דרך (milestones)

טבלת אבני דרך מחליפה את טבלת השלבים (stages) הקיימת ומרחיבה אותה.

| שדה | סוג נתונים | תיאור |
|-----|------------|-------|
| id | uuid | מזהה ייחודי |
| title | text | כותרת אבן הדרך |
| description | text | תיאור |
| project_id | uuid | מזהה הפרויקט (מפתח זר) |
| status | text | סטטוס |
| priority | text | עדיפות |
| department | text | מחלקה |
| responsible | uuid | אחראי |
| planned_start_date | date | תאריך התחלה מתוכנן |
| planned_end_date | date | תאריך סיום מתוכנן |
| actual_start_date | date | תאריך התחלה בפועל |
| actual_end_date | date | תאריך סיום בפועל |
| reminder_date | date | תאריך תזכורת |
| created_at | timestamptz | תאריך יצירה |
| updated_at | timestamptz | תאריך עדכון |
| sort_order | integer | סדר תצוגה |

### 4. טבלת תבניות אבני דרך (milestone_templates)

טבלה חדשה המכילה את תבניות אבני הדרך הקבועות.

| שדה | סוג נתונים | תיאור |
|-----|------------|-------|
| id | uuid | מזהה ייחודי |
| title | text | כותרת אבן הדרך |
| description | text | תיאור |
| sort_order | integer | סדר תצוגה |
| created_at | timestamptz | תאריך יצירה |
| updated_at | timestamptz | תאריך עדכון |

### 5. טבלת משימות (tasks)

טבלת המשימות המורחבת, כוללת תמיכה ברמות משימות.

| שדה | סוג נתונים | תיאור |
|-----|------------|-------|
| id | uuid | מזהה ייחודי |
| title | text | כותרת המשימה |
| description | text | תיאור |
| project_id | uuid | מזהה הפרויקט (מפתח זר) |
| milestone_id | uuid | מזהה אבן הדרך (מפתח זר) |
| parent_task_id | uuid | מזהה משימת האב (מפתח זר) |
| hierarchical_number | text | מספר היררכי |
| task_level | integer | רמת המשימה (1=משימה, 2=תת משימה, 3=תת תת משימה) |
| is_planned | boolean | האם מתוכננת מראש או אד-הוק |
| status | text | סטטוס |
| priority | text | עדיפות |
| category | text | קטגוריה |
| tag | text | תגית |
| department | text | מחלקה |
| responsible | uuid | אחראי |
| estimated_hours | numeric | שעות מוערכות |
| actual_hours | numeric | שעות בפועל |
| planned_start_date | date | תאריך התחלה מתוכנן |
| planned_end_date | date | תאריך סיום מתוכנן |
| actual_start_date | date | תאריך התחלה בפועל |
| actual_end_date | date | תאריך סיום בפועל |
| completed_date | date | תאריך סיום |
| reminder_date | date | תאריך תזכורת |
| budget | numeric | תקציב |
| deleted | boolean | האם נמחק |
| created_at | timestamptz | תאריך יצירה |
| updated_at | timestamptz | תאריך עדכון |

## תהליך המיגרציה

המיגרציה כוללת את השלבים הבאים:

1. גיבוי הטבלאות הקיימות על ידי שינוי שמן (projects -> projects_old, stages -> stages_old, tasks -> tasks_old).
2. יצירת הטבלאות החדשות עם המבנה המורחב.
3. העברת הנתונים מהטבלאות הישנות לחדשות.
4. יצירת אבני הדרך הקבועות לכל פרויקט חדש באופן אוטומטי.
5. עדכון המידע על רמות המשימות וסיווגן כמתוכננות או אד-הוק.

## פונקציות חדשות במסד הנתונים

1. **create_default_milestones_for_project** - יוצרת אוטומטית את אבני הדרך הקבועות לפרויקט חדש.
2. **generate_hierarchical_number** - יוצרת מספר היררכי למשימה חדשה בהתאם למיקומה בעץ המשימות.
3. **add_task** - מוסיפה משימה חדשה עם חישוב אוטומטי של רמת המשימה והאם היא מתוכננת.
4. **get_project_milestones** - מחזירה את אבני הדרך של פרויקט מסוים בסדר הנכון.
5. **get_milestone_tasks** - מחזירה את כל המשימות הראשיות של אבן דרך ספציפית.
6. **get_subtasks** - מחזירה את כל תתי המשימות של משימה ספציפית.

## טריגרים אוטומטיים

1. **set_updated_at** - מעדכן את שדה updated_at בכל שינוי ברשומה.
2. **create_default_milestones_on_project_creation** - יוצר אוטומטית את אבני הדרך הקבועות כאשר נוצר פרויקט חדש.

## שינויים בקוד הלקוח

יש לעדכן את הקוד בצד הלקוח כדי לעבוד עם המבנה החדש, כולל:

1. עדכון הטיפוסים ב-TypeScript.
2. עדכון בקשות ה-API לעבודה עם הטבלאות החדשות.
3. עדכון הממשק המשתמש להצגת רמות המשימות ואבני הדרך.

## צעדים הבאים

1. יצירת גיבוי מלא של בסיס הנתונים לפני המיגרציה.
2. הרצת קבצי המיגרציה בסביבת פיתוח לבדיקת התהליך.
3. עדכון הקוד בצד הלקוח לעבודה עם המבנה החדש.
4. ביצוע בדיקות מקיפות של המערכת החדשה.
5. הרצת המיגרציה בסביבת הייצור. 