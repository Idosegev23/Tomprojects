# מערכת ניהול פרויקטים לתום הרוש

מערכת ניהול פרויקטים של נדל"ן המיועדת למשרד הראשי, המאפשרת לראות, להוסיף ולערוך פרויקטים ומשימות (כולל תתי‑משימות) בצורה פשוטה.

## תכונות עיקריות

- **ניהול פרויקטים** - יצירה, עריכה וצפייה בפרויקטי נדל"ן
- **ניהול משימות** - יצירה, עריכה וצפייה במשימות ותתי-משימות
- **תצוגות מרובות** - לוח קנבן, עץ היררכי, גאנט ורשימה
- **תבניות** - יצירת פרויקטים מבוססי תבניות עם משימות מוגדרות מראש
- **תמיכה מלאה במובייל** - ממשק רספונסיבי המותאם לכל גודל מסך

## טכנולוגיות

- **Frontend**: Next.js, React, Tailwind CSS, Chakra UI
- **Backend**: Supabase (PostgreSQL)
- **ניהול מצב**: React Query
- **גרירה ושחרור**: react-beautiful-dnd
- **לוח זמנים**: FullCalendar
- **רספונסיביות**: Chakra UI Responsive API, CSS Media Queries

## התקנה והפעלה

### דרישות מקדימות

- Node.js (גרסה 16 ומעלה)
- Yarn או npm
- חשבון Supabase

### התקנה

1. שכפל את המאגר:
```bash
git clone <repository-url>
cd tom-project
```

2. התקן את התלויות:
```bash
yarn install
# או
npm install
```

3. הגדר את משתני הסביבה:
   - צור קובץ `.env.local` בתיקייה הראשית
   - הוסף את המשתנים הבאים:
   ```
   NEXT_PUBLIC_SUPABASE_URL=https://orgkbmxecoegyjojoqmh.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yZ2tibXhlY29lZ3lqb2pvcW1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4NjMyODYsImV4cCI6MjA1NDQzOTI4Nn0.jK13G36VU7eLVQsxsXLhlYLKafISrh9j8QIWIQH7TVs
   ```

4. הפעל את השרת:
```bash
yarn dev
# או
npm run dev
```

5. פתח את הדפדפן בכתובת [http://localhost:3000](http://localhost:3000)

## תמיכה במובייל ורספונסיביות

המערכת תומכת באופן מלא במכשירים ניידים וטאבלטים בכל הגדלים. התכונות העיקריות כוללות:

- **תפריט צד מותאם** - תפריט צד שמתחלף לתפריט נשלף במסכים קטנים
- **פריסה דינמית** - התאמה אוטומטית של פריסת הדפים לגודל המסך
- **טבלאות רספונסיביות** - טבלאות שמתאימות את עצמן למסכים קטנים
- **כרטיסיות מותאמות** - כרטיסיות פרויקטים ומשימות שמשנות את הפריסה שלהן במובייל
- **טפסים מותאמים** - טפסי יצירה ועריכה שמתאימים את עצמם למסכים קטנים

### נקודות שבירה (Breakpoints)

המערכת משתמשת בנקודות השבירה הבאות:
- **sm**: 480px ומעלה
- **md**: 768px ומעלה
- **lg**: 992px ומעלה
- **xl**: 1280px ומעלה
- **2xl**: 1536px ומעלה

## כלים ותסריטים

### עדכון סכמת מסד הנתונים

הפרויקט כולל סקריפט אוטומטי לעדכון ותיעוד סכמת מסד הנתונים:

```bash
./scripts/update_schema.sh
```

הסקריפט מייצר קובץ `database_schema.md` עם תיעוד מלא של מבנה מסד הנתונים, כולל:
- רשימת טבלאות
- עמודות וסוגי נתונים
- מפתחות ראשיים וזרים
- אילוצים

**הערה**: יש להריץ את הסקריפט בכל פעם שיש שינוי בסכמת מסד הנתונים.

#### עדכון אוטומטי

הפרויקט כולל גם git hook שמעדכן את סכמת מסד הנתונים באופן אוטומטי בכל פעם שיש commit עם שינויים בקבצי SQL או בקבצים הקשורים למסד הנתונים. ה-hook נמצא בנתיב `.git/hooks/pre-commit`.

אם ברצונך להפעיל את ה-hook באופן ידני, הרץ:

```bash
.git/hooks/pre-commit
```

### פונקציות SQL

הפרויקט כולל גם קובץ SQL עם פונקציות RPC שיכולות לשמש לקבלת מידע על הסכמה:

```bash
# התקנת פונקציות ה-RPC בסופהבייס (דורש Docker)
supabase db execute -f scripts/create_rpc_functions.sql
```

## מבנה הפרויקט

- `src/pages/` - דפי האפליקציה
- `src/components/` - קומפוננטות React
- `src/services/` - שירותים לתקשורת עם Supabase
- `src/types/` - טיפוסי TypeScript
- `src/utils/` - פונקציות עזר
- `scripts/` - סקריפטים שימושיים
- `supabase/` - הגדרות Supabase

## תיעוד נוסף

- [מסמך אפיון](build_tracking.md) - אפיון מפורט של המערכת
- [סכמת מסד הנתונים](database_schema.md) - תיעוד מבנה מסד הנתונים

## כללי עבודה

ראה [כללי עבודה](rule.mdc) לפרטים על כללי העבודה בפרויקט.

## רישיון

כל הזכויות שמורות © תום הרוש 

## הוראות התקנה

1. התקן את הספריות הנדרשות:
```bash
npm install
```

2. הגדר את משתני הסביבה בקובץ `.env.local`:
```
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

3. הפעל את השרת המקומי:
```bash
npm run dev
```

## הגדרת פונקציות SQL בשרת Supabase

כדי לאפשר יצירת טבלאות ספציפיות לפרויקטים, יש להעלות את הפונקציות SQL הבאות לשרת Supabase:

1. התחבר לפאנל הניהול של Supabase
2. עבור ל-SQL Editor
3. לחץ על "New Query"
4. העתק את תוכן הקובץ `sql/project_tables.sql` לעורך
5. לחץ על "Run" כדי ליצור את הפונקציות

הפונקציות שיווצרו:
- `check_table_exists` - בדיקה אם טבלה קיימת
- `create_project_table` - יצירת טבלת משימות ספציפית לפרויקט
- `drop_project_table` - מחיקת טבלת משימות ספציפית לפרויקט
- `copy_task_to_project_table` - העתקת משימה לטבלה הספציפית של הפרויקט
- `update_task_in_project_table` - עדכון משימה בטבלה הספציפית של הפרויקט
- `delete_task_from_project_table` - מחיקת משימה מהטבלה הספציפית של הפרויקט
- `get_project_tasks` - קבלת כל המשימות מהטבלה הספציפית של הפרויקט
- `sync_project_tasks` - סנכרון כל המשימות של פרויקט מהטבלה הראשית לטבלה הספציפית

בנוסף, יווצרו טריגרים שיפעילו את הפונקציות באופן אוטומטי בעת יצירת או מחיקת פרויקט.

## שימוש בטבלאות ספציפיות לפרויקטים

לאחר הגדרת הפונקציות SQL, המערכת תיצור באופן אוטומטי טבלה ספציפית לכל פרויקט חדש. הטבלה תכיל את כל המשימות של הפרויקט ותאפשר ביצועים טובים יותר בפרויקטים גדולים.

ניתן לסנכרן את המשימות בין הטבלה הראשית לטבלה הספציפית באמצעות כפתור "סנכרון משימות" בדף הפרויקט.

# פתרון לבעיות הרשאות וטבלאות מותאמות פרויקט

מדריך זה מסביר כיצד להתקין ולהפעיל את הפתרון לבעיות ההרשאות והיצירה האוטומטית של טבלאות ייחודיות לפרויקטים במערכת. הפתרון כולל מנגנון אוטומטי ליצירת טבלאות פרויקט בעת יצירת פרויקט חדש והענקת הרשאות מתאימות.

## תקציר הפתרון

הפתרון מבוסס על הוספת מיגרציה שיוצרת:
1. פונקציות עזר לבדיקת קיום טבלאות
2. פונקציה ליצירת טבלאות ייחודיות לפרויקט
3. טריגר שמופעל אוטומטית בעת יצירת פרויקט חדש
4. פונקציות RPC לאתחול, שליפת נתונים ועבודה עם טבלאות הפרויקט
5. הענקת הרשאות גישה מתאימות לכל המשתמשים

## דרישות מקדימות

1. גישה לממשק SQL של Supabase
2. גישת מנהל (Service Role) ל-API של Supabase
3. Node.js מותקן (גרסה 14 ומעלה)

## שלבי היישום

### אפשרות 1: הרצה אוטומטית של כל התיקונים

זוהי האפשרות המומלצת והפשוטה ביותר.

1. ודא שקובץ `.env.local` כולל את המשתנים הבאים:
   ```
   NEXT_PUBLIC_SUPABASE_URL=https://your-project-url.supabase.co
   SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
   ```

2. הרץ את סקריפט התיקונים האוטומטי:
   ```bash
   node scripts/fix_all_issues.mjs
   ```

3. המתן לסיום הריצה של כל השלבים. הסקריפט יבצע:
   - תיקון הרשאות לטבלת stages
   - תיקון מבנה טבלת stages
   - התקנת פונקציית אתחול טבלאות פרויקט
   - התקנת הטריגר האוטומטי ליצירת טבלאות
   - בדיקה ויצירת פרויקט לדוגמה (במידת הצורך)
   - יצירת הטבלאות הייחודיות לפרויקט
   - אתחול הטבלאות עם נתונים ראשוניים

4. רענן את הדפדפן באפליקציה שלך וודא שהבעיות נפתרו

### אפשרות 2: הרצה ידנית דרך ממשק SQL של Supabase

אם אינך יכול להשתמש בסקריפט האוטומטי, באפשרותך להריץ את הקבצים באופן ידני:

1. פתח את ממשק SQL ב-Supabase
2. הרץ את הקבצים הבאים לפי הסדר:
   - `scripts/fix_stages_permissions.sql`
   - `scripts/fix_stages_table.sql`
   - `scripts/init_project_function.sql`
   - `supabase/migrations/20250410000000_create_project_triggers.sql`

3. הרץ את הפקודה הבאה כדי ליצור טבלאות עבור פרויקט ספציפי (החלף את מזהה הפרויקט):
   ```sql
   SELECT create_project_tables('YOUR-PROJECT-UUID-HERE');
   ```

4. הרץ את הפקודה הבאה כדי לאתחל את טבלאות הפרויקט עם נתונים התחלתיים:
   ```sql
   SELECT init_project_tables_and_data('YOUR-PROJECT-UUID-HERE', true, true);
   ```

## כיצד הפתרון עובד

### טריגר אוטומטי

הפתרון מבוסס על טריגר שמופעל אוטומטית בכל פעם שנוצר פרויקט חדש בטבלת `projects`. הטריגר קורא לפונקציה שיוצרת את הטבלאות הייחודיות לפרויקט:

```sql
CREATE TRIGGER project_after_insert
AFTER INSERT ON projects
FOR EACH ROW
EXECUTE FUNCTION project_after_insert_trigger();
```

### יצירת טבלאות ייחודיות

הפונקציה `create_project_tables` יוצרת שתי טבלאות לכל פרויקט:
- טבלת משימות: `project_{PROJECT_ID}_tasks`
- טבלת שלבים: `project_{PROJECT_ID}_stages`

כל טבלה מקבלת הרשאות מתאימות לכל סוגי המשתמשים ו-RLS מבוטל.

### אתחול נתונים ראשוניים

הפונקציה `init_project_tables_and_data` מאתחלת את הטבלאות עם:
- שלבים התחלתיים (10 שלבים סטנדרטיים)
- משימות התחלתיות (10 משימות לדוגמה)

### פונקציות RPC לגישה לנתונים

נוספו שתי פונקציות חשובות לשימוש בקוד האפליקציה:
- `get_project_tasks` - להחזרת כל המשימות של פרויקט ספציפי
- `get_tasks_tree` - להחזרת עץ משימות היררכי של פרויקט

## איתור תקלות

אם עדיין נתקלת בבעיות אחרי הרצת הפתרון:

1. בדוק את הרשאות הגישה לטבלאות הפרויקט:
   ```sql
   GRANT ALL PRIVILEGES ON TABLE project_{PROJECT_ID}_tasks TO anon, authenticated, service_role;
   GRANT ALL PRIVILEGES ON TABLE project_{PROJECT_ID}_stages TO anon, authenticated, service_role;
   ```

2. ודא שה-RLS מבוטל:
   ```sql
   ALTER TABLE project_{PROJECT_ID}_tasks DISABLE ROW LEVEL SECURITY;
   ALTER TABLE project_{PROJECT_ID}_stages DISABLE ROW LEVEL SECURITY;
   ```

3. בדוק שהפרויקט קיים בטבלת `projects`:
   ```sql
   SELECT * FROM projects WHERE id = '{PROJECT_ID}';
   ```

## שדרוגים עתידיים

הפתרון הנוכחי מבוסס על מנגנון אוטומטי, אך ניתן לשדרג אותו בעתיד:

1. הוספת מנגנון לשכפול תבניות פרויקט שלמות
2. מערכת ניהול הרשאות מתקדמת יותר לטבלאות הפרויקט
3. אופטימיזציה של שאילתות בפרויקטים גדולים

## תמיכה

אם נתקלת בבעיות נוספות או יש לך שאלות, אנא צור קשר בכתובת הדוא"ל [תמיכה]. 