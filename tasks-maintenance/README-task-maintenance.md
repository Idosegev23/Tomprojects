# כלי תחזוקה למערכת המשימות

קובץ זה מתאר את כלי התחזוקה למערכת המשימות במערכת. כלים אלה נועדו לאתר ולתקן כפילויות בטבלת המשימות ולהבטיח שהמשימות נמצאות בטבלאות הנכונות.

## רקע

לאחר עדכון מערכת המשימות לעבוד עם טבלאות ייחודיות לכל פרויקט, ייתכן שיש כפילויות בטבלת `tasks` הראשית:
1. משימות ללא `project_id` (גלובליות/תבניות) אמורות להישאר בטבלת `tasks`.
2. משימות עם `project_id` אמורות להימצא רק בטבלאות ייחודיות של הפרויקטים (`project_[id]_tasks`).

הכלים הבאים מסייעים בניקוי ותחזוקת מבנה הנתונים.

## הסקריפטים

### 1. חיפוש כפילויות (`find-duplicate-tasks.js`)

סקריפט זה:
- מתחבר לסופאבייס ומושך את כל המשימות מטבלת `tasks`
- מקבץ את המשימות לפי כותרת (`title`) ומציג כפילויות
- מפריד בין משימות גלובליות (ללא `project_id`) למשימות השייכות לפרויקטים
- מספק סטטיסטיקה על מספר הכפילויות שנמצאו
- מציע לך להפעיל את סקריפט התיקון

### 2. תיקון כפילויות (`fix-duplicate-tasks.js`)

סקריפט זה:
- טיפול בכפילויות במשימות גלובליות:
  - שומר רק גרסה אחת (העדכנית ביותר) מכל משימה גלובלית
  - מוחק את שאר הכפילויות
- טיפול במשימות ייחודיות לפרויקטים:
  - בודק אם קיימת טבלה ייחודית לכל פרויקט (ויוצר במידת הצורך)
  - מסנכרן את המשימות מטבלת `tasks` לטבלאות הייחודיות
  - מוחק את המשימות הללו מטבלת `tasks` הראשית

### 3. פונקציות SQL נדרשות (`fix-tasks-db-functions.sql`)

קובץ SQL עם פונקציות שצריך להוסיף לסופאבייס:
- `check_table_exists` - בדיקה אם טבלה קיימת
- `create_project_table` - יצירת טבלה חדשה לפרויקט
- `sync_project_tasks` - סנכרון משימות בין טבלאות
- `add_tasks_to_project_table` - הוספת משימות לטבלה של פרויקט

### 4. גיבוי נתונים (`backup-tasks.js`)

סקריפט זה:
- מגבה את כל המשימות מטבלת `tasks` הראשית לקובץ JSON
- מאתר ומגבה גם את כל הטבלאות הספציפיות לפרויקטים, אם קיימות
- שומר את קבצי הגיבוי בתיקיית `backups` עם חותמת זמן ייחודית
- מספק הוראות כיצד לשחזר את הנתונים במקרה הצורך
- בודק אם פונקציית `get_project_tables` קיימת בסופאבייס ומציע ליצור אותה אם לא

## התקנה והפעלה

### הכנות מקדימות

1. וודא שיש לך Node.js מותקן (גרסה 14 ומעלה)
2. התקן את החבילות הנדרשות:
   ```
   npm install dotenv @supabase/supabase-js
   ```
3. צור קובץ `.env` עם פרטי החיבור לסופאבייס:
   ```
   NEXT_PUBLIC_SUPABASE_URL=https://your-project-url.supabase.co
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   ```
4. הוסף את פונקציות ה-SQL לסופאבייס:
   - התחבר לממשק ה-SQL של סופאבייס
   - העתק את תוכן הקובץ `fix-tasks-db-functions.sql`
   - הפעל את השאילתות

### הפעלת הסקריפטים

#### 1. חיפוש כפילויות
```
node find-duplicate-tasks.js
```

הסקריפט יציג את הכפילויות שנמצאו וישאל אותך אם ברצונך להפעיל את סקריפט התיקון. אם תבחר "y", הסקריפט יפעיל אוטומטית את `fix-duplicate-tasks.js`.

#### 2. תיקון כפילויות (הפעלה ישירה)
```
node fix-duplicate-tasks.js
```

#### 3. גיבוי נתונים (חשוב לפני תיקון!)
```
node backup-tasks.js
```
או
```
npm run backup
```

הסקריפט יגבה את כל המשימות מטבלת `tasks` וגם מטבלאות הספציפיות לפרויקטים לקבצי JSON בתיקיית `backups`. מומלץ להריץ אותו לפני ביצוע כל פעולת תיקון.

## שים לב

* **גיבוי**: **חשוב מאוד** לבצע גיבוי של הנתונים לפני הפעלת הסקריפטים באמצעות הרצת `npm run backup` או `node backup-tasks.js`
* **השפעות**: 
  - הסקריפטים ישנו את מבנה הנתונים וימחקו משימות כפולות
  - משימות תימחקנה מטבלת `tasks` ויועברו לטבלאות הספציפיות של הפרויקטים
* **הפעלה בסביבת ייצור**: מומלץ להפעיל קודם בסביבת פיתוח או בדיקות

## בעיות נפוצות

* **שגיאת חיבור לסופאבייס**: וודא שפרטי החיבור בקובץ `.env` נכונים
* **שגיאת RPC**: וודא שהוספת את כל פונקציות ה-SQL לסופאבייס
* **שגיאות הרשאה**: וודא שיש לך הרשאות מספקות בסופאבייס

## סיכום

השימוש בכלים אלה יעזור לנקות את מבנה הנתונים של המשימות ולהבטיח שהמשימות נמצאות בטבלאות הנכונות, בהתאם לארכיטקטורה החדשה שבה משימות ספציפיות לפרויקט נשמרות בטבלאות ייעודיות. 